// Message simulator - Hisense NGB project testing tool
// Copyright 2012 Hisense Inc.  All rights reserved.
//
// This software is free; you can redistribute it and/or modify it under
// the term of GNU Lesser General Public License as published by the free
// software Foundation; either version 2.1 of the License, or (at your
// option) any later version.
//
// This software is distributed in the hope that it will be useful, but
// WITHOUT ANY WARRANTY; without even the implied warranty, See the GNU
// Lesser General Public License for more details.
//
// Author: wangliang8@hisense.com (Denny Wang)
// History: created @2012/10/10

#include <sstream>
#include "log.hh"
#include "run_item.hh"
#include "config_manager.hh"
#include "utils.hh"
#include "message.hh"

RunItem::RunItem(std::string line)
{
  setupRunItems(line);
}

void RunItem::processItem()
{
  debugLog(NGB_RUN_ITEM, "RunItem::processItem enter...");
  if (mode_ == 'T') {
    debugLog(NGB_RUN_ITEM, "RunItem::processItem sending message");
    sendMessage();
  } else if (mode_ == 'R') {
    debugLog(NGB_RUN_ITEM, "RunItem::processItem receiving message");
    receiveMessage();
  } else {
    debugLog(NGB_RUN_ITEM, "RunItem::processItem unknown item mode");
    return;
  }
  
  debugLog(NGB_RUN_ITEM, "RunItem::processItem exit...");
}

bool RunItem::setupRunItems(std::string line)
{
  debugLog(NGB_RUN_ITEM, "RunItem::setupRunItems enter...");
  std::istringstream iss(line);
  iss >> mode_;
  std::string time;
  iss >> time;
  sscanf(time.c_str(), "%d", &timeOut_);
  std::string path;
  iss >> path;
  pathOfMessage_ = Utils::Path(ConfigManager::getCWD()) + Utils::Path(path);
  debugLog(NGB_RUN_ITEM,
           "RunItem::setupRunItems get parameters: "
           "mode(%c), timeOut(%d), pathOfMessage(%s)",
           mode_, timeOut_, pathOfMessage_.c_str());
  debugLog(NGB_RUN_ITEM, "RunItem::setupRunItems exit...");
}

bool RunItem::sendMessage()
{
  debugLog(NGB_RUN_ITEM, "RunItem::sendMessage enter...");
  Message msg(pathOfMessage_.getPath());
  msg.readMsgFile();
  msg.print();
  debugLog(NGB_RUN_ITEM, "RunItem::sendMessage exit...");
}

bool RunItem::receiveMessage()
{
  debugLog(NGB_RUN_ITEM, "RunItem::receiveMessage enter...");
  debugLog(NGB_RUN_ITEM, "RunItem::receiveMessage exit...");
}
